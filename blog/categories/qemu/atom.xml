<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Qemu | My code works, I don't know why.]]></title>
  <link href="http://wen00072.github.io/blog/categories/qemu/atom.xml" rel="self"/>
  <link href="http://wen00072.github.io/"/>
  <updated>2016-09-27T14:45:19+08:00</updated>
  <id>http://wen00072.github.io/</id>
  <author>
    <name><![CDATA[Wen Liao]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Linux Kernel Pratice 0: Buildroot (1)]]></title>
    <link href="http://wen00072.github.io/blog/2016/09/27/linux-kernel-pratice-0-buildroot-setup-with-qemu/"/>
    <updated>2016-09-27T09:43:20+08:00</updated>
    <id>http://wen00072.github.io/blog/2016/09/27/linux-kernel-pratice-0-buildroot-setup-with-qemu</id>
    <content type="html"><![CDATA[<p>理論上不應該要邊移動邊開火，延長戰線。不過計劃趕不上變化，既來之則安之。</p>

<p>最近因為特別因素開始學習Linux kernel，看能不能Linux kernel和STM32兩邊都不要漏掉。不管怎樣，學習和實習絕對分不開，所以還是從環境架設開始吧。這次的實習環境架設的目標是：</p>

<ol>
<li>可以使用ARM 平台。一方面追求流行，一方面我不想再開x86這個副本</li>
<li>可以方便地建立ARM平台的Linux Rootfs和kernel版本</li>
<li>可以方便地更改指定要編譯的Kernel版本</li>
<li>透過Qemu ，使用2的Rootfs和kernel開機</li>
<li>透過Qemu和搭配的工具可以分析Linux kernel的run time 行為</li>
</ol>


<p>今天只有辦到1和2而已，剩下的還要繼續努力。</p>

<h2>目錄</h2>

<ul>
<li><a href="#lk0_env">測試環境</a></li>
<li><a href="#lk0_ins">安裝Buildroot</a>

<ul>
<li><a href="#lk0_ins_dl">下載Buildroot</a></li>
<li><a href="#lk0_ins_set">設定ARM 環境</a></li>
<li><a href="#lk0_ins_build">編譯及輸出</a></li>
</ul>
</li>
<li><a href="#lk0_test">測試</a></li>
<li><a href="#lk0_ref">參考資料</a>

<ul>
<li><a href="#lk0_ref_data">下次準備看的資料</a></li>
</ul>
</li>
</ul>


<p><a name="lk0_env"></a></p>

<h2>測試環境</h2>

<p>因為我已經裝過開發相關的套件，因此如果您是新手可能要自行摸索也許有需要另外安裝的套件如<code>git</code>。嘛，練習解讀錯誤訊息也是一種學習。</p>

<pre>
$ lsb_release -a
No LSB modules are available.
Distributor ID: Ubuntu
Description:    Ubuntu 14.04.5 LTS
Release:    14.04
Codename:   trusty
</pre>


<p><a name="lk0_ins"></a></p>

<h2>安裝Buildroot</h2>

<p>主要分成下面三個步驟</p>

<ul>
<li><a href="#lk0_ins_dl">下載Buildroot</a></li>
<li><a href="#lk0_ins_set">設定ARM 環境</a></li>
<li><a href="#lk0_ins_build">編譯及輸出</a></li>
</ul>


<p><a name="lk0_ins_dl"></a></p>

<h3>下載Buildroot</h3>

<p>直接看例子，剪下貼上就好</p>

<pre><code class="sh">mkdir buildroot
cd buildroot
git clone git://git.buildroot.net/buildroot
</code></pre>

<p><a name="lk0_ins_set"></a></p>

<h3>設定ARM 環境</h3>

<p>網路上查到大部分都是從<code>make menuconfig</code>開始。不過我是很<strong>明確地</strong>要用<code>Qemu</code>跑ARM的系統。所以就找了一下發現有下面的指令</p>

<pre><code class="text">make qemu_x86_defconfig
</code></pre>

<p>想說既然有<code>x86_defconfig</code>，那應該有<code>arm_defconfig</code>吧? 錯！那我就去<code>buildroot/board/qemu</code>目錄下找，有看到<code>arm-versatile</code>。印象中<a href="blog/2015/02/07/by-qemu-arm-installation-of-debian-systems/">以前</a>有用過Qemu跑的Debian系統也是<code>versatile</code>。所以就很高興地下了</p>

<pre><code class="text">make qemu_arm-versatile_defconfig
</code></pre>

<p>結果一樣GG，估狗查才知道正確的用法是：</p>

<pre><code>make qemu_arm_versatile_defconfig
</code></pre>

<p>接下來就用<code>make menuconfig</code>做細項調整，我主要是改成</p>

<ol>
<li>使用glibc</li>
<li>使用gcc 4.8

<ul>
<li>預設5.x，因為我想要編Linux kernel 4.4.2。以前PC經驗使用gcc 5.x極端痛苦，後來還是換回gcc 4.8</li>
</ul>
</li>
<li>一些除錯設定</li>
</ol>


<p>另外本來想要嘗試設定更動Kernel版本，但是發現需要更進一步的了解buildroot才能夠達成。當作下次目標吧。</p>

<p><a name="lk0_ins_build"></a></p>

<h3>編譯及輸出</h3>

<p>編譯只要下<code>make</code>就會幫你下載和編譯開機需要的</p>

<ol>
<li>套件和一些常用工具，並封裝到<code>output/image/roofs.ext2</code></li>
<li>Kernel(預設4.7)，編譯成<code>zImage</code>，放在<code>output/image/zImage</code></li>
</ol>


<p><a name="lk0_test"></a></p>

<h2>測試</h2>

<p>接下來也不難，可以參考<code>board/qemu/arm-versatile/readme.txt</code>
簡單來說就是執行下面指令，開機完使用<code>root</code>登入不用密碼，使用<code>poweroff</code>後再手動離開qemu。</p>

<pre><code class="sh">qemu-system-arm -M versatilepb -kernel output/images/zImage -dtb output/images/versatile-pb.dtb -drive file=output/images/rootfs.ext2,if=scsi,format=raw -append "root=/dev/sda console=ttyAMA0,115200" -serial stdio -net nic,model=rtl8139 -net user
</code></pre>

<p>執行畫面如下</p>

<pre><code class="text">$ qemu-system-arm -M versatilepb -kernel output/images/zImage -dtb output/images/versatile-pb.dtb -drive file=output/images/rootfs.ext2,if=scsi,format=raw -append "root=/dev/sda console=ttyAMA0,115200" -serial stdio -net nic,model=rtl8139 -net user
...
Booting Linux on physical CPU 0x0
Linux version 4.7.0 (user@host) (gcc version 4.8.5 (Buildroot 2016.11-git-00439-g14b2472) ) #1 Mon Sep 26 22:36:42 CST 2016
CPU: ARM926EJ-S [41069265] revision 5 (ARMv5TEJ), cr=00093177
CPU: VIVT data cache, VIVT instruction cache
Machine model: ARM Versatile PB
....
EXT4-fs (sda): re-mounted. Opts: block_validity,barrier,user_xattr,errors=remount-ro
Starting logging: OK
Initializing random number generator... random: dd urandom read with 46 bits of entropy available
done.
Starting network: 8139cp 0000:00:0c.0 eth0: link up, 100Mbps, full-duplex, lpa 0x05E1
...
adding dns 10.0.2.3
OK

Welcome to Buildroot
buildroot login: root
#
</code></pre>

<p><a name="lk0_ref"></a></p>

<h2>參考資料</h2>

<ul>
<li><a href="https://buildroot.org/downloads/manual/manual.html">The Buildroot user manual</a>

<ul>
<li>只有看部份，不過官方文件本來就是應該放在第一位</li>
</ul>
</li>
<li><a href="http://pressreset.net/2013/09/buildroot-and-qemu-the-quickest-receipe-for-your-own-linux/">Buildroot and QEMU – the quickest receipe for your own Linux</a>

<ul>
<li>東西弄完才看到的文章，入門好文</li>
</ul>
</li>
</ul>


<p><a name="lk0_ref_data"></a></p>

<h3>下次準備看的資料</h3>

<ul>
<li><a href="http://www.linux-magazine.com/Online/Features/Qemu-and-the-Kernel">Qemu and the Kernel</a>

<ul>
<li>使用Qemu debug kernel的資料</li>
</ul>
</li>
<li><a href="http://unix.stackexchange.com/questions/90423/can-virtfs-9p-be-used-as-root-file-system">Stackoverflow: Can virtfs/9p be used as root file system?</a>

<ul>
<li>Qemu和Host主機共享資料，甚至直接把rootfs放host讓qemu去讀取的方式</li>
</ul>
</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[在X86 Linux下透過Qemu安裝ARM的Debian系統]]></title>
    <link href="http://wen00072.github.io/blog/2015/02/07/by-qemu-arm-installation-of-debian-systems/"/>
    <updated>2015-02-07T00:40:00+08:00</updated>
    <id>http://wen00072.github.io/blog/2015/02/07/by-qemu-arm-installation-of-debian-systems</id>
    <content type="html"><![CDATA[<p>安裝順序如下</p>

<h2>測試環境</h2>

<pre><code>$ lsb_release -a
No LSB modules are available.
Distributor ID: Ubuntu
Description:    Ubuntu 14.04.1 LTS
Release:    14.04
Codename:   trusty
</code></pre>

<h2>安裝Qemu</h2>

<pre><code>$ sudo apt-get install qemu-system-arm
</code></pre>

<h2>拉ARM安裝相關檔案</h2>

<ul>
<li>首先先來看Qemu有支援那些ARM平台
<code>
$ qemu-system-arm -machine help
Supported machines are:
versatileab          ARM Versatile/AB (ARM926EJ-S)
versatilepb          ARM Versatile/PB (ARM926EJ-S)
lm3s811evb           Stellaris LM3S811EVB
...
</code></li>
</ul>


<p>安裝ARM版本Debian需要</p>

<ul>
<li>kernel</li>
<li>initrd</li>
<li>ISO
首先到提供Debian下載的網站中的debian/dists找一個你想安裝的版本，我選了7.8 (Wheezy)。
假設Debain下載網站叫host</li>
</ul>


<p>先抓平台相關的kernel和initrd，路徑如下</p>

<pre>http://host/debian/dists/Debian7.8/main/installer-armel/20130430/images/</pre>


<p>下面有不同的ARM平台，還記得上面<code>qemu-system-arm -machine help</code>，請和這邊目錄下的比對，挑一個順眼的。我使用
versatile，所以就切到下面的目錄</p>

<pre>http://host/debian/dists/Debian7.8/main/installer-armel/20130430/images/versatile/netboot/</pre>


<p>把下面的兩個檔案拉下來</p>

<ul>
<li>initrd.gz</li>
<li>vmlinuz-3.2.0-4-versatile</li>
</ul>


<p>接下來在同樣的主機上，下載ISO檔。</p>

<pre>http://host/debian-cd/7.8.0/armel</pre>


<h2>開始安裝</h2>

<p>透過下面的指令安裝虛擬磁碟，請自行決定大小
<code>
$ qemu-img create debian.img 8G
</code></p>

<p>然後叫qemu載入ARM kernel，initrd，以及ISO
<code>
$ qemu-system-arm -M versatileab -kernel ./vmlinuz-3.2.0-4-versatile -initrd ./initrd.gz -cdrom ./debian-7.8.0-armel-DVD-1.iso -hda debian.img -m 1024
</code>
這邊可以看到versatileab又出現了，請往上找一下這個字串吧。</p>

<h2>抽出虛擬磁碟的kernel和initrd</h2>

<p>最tricky的地方在這邊，理論上你要透過loopback裝置mount 虛擬磁碟，複製/boot就可以了。但是現實就是，因為磁碟機/root的partition有offset，所以直接mount程式無法辨認Filesystem所以無法mount。正確方式如下</p>

<pre><code>$ sudo fdisk -l -u debian.img 

Disk debian.img: 8589 MB, 8589934592 bytes
255 heads, 63 sectors/track, 1044 cylinders, total 16777216 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk identifier: 0x000823a0

     Device Boot      Start         End      Blocks   Id  System
debian.img1            2048    15988735     7993344   83  Linux
debian.img2        15990782    16775167      392193    5  Extended
debian.img5        15990784    16775167      392192   82  Linux swap / Solaris
</code></pre>

<p>有兩個東西要注意</p>

<ul>
<li>unit為512 bytes</li>
<li>root partition offset為2048個unit</li>
</ul>


<p>所以正確的mount方式如下</p>

<pre><code>$ sudo mount -o loop,offset=$((2048 * 512)) debian.img /mnt
</code></pre>

<p>接下來抽出就簡單了，請在剛才安裝的虛擬磁碟檔案同一個目錄操作。</p>

<pre><code>$ mkdir boot
$ cp /mnt/boot/* boot/ -rv
</code></pre>

<h2>載入安裝的系統</h2>

<p>這邊就照表操課，我有指定localhost將port 2222 forward到Qemu的port 22，以便將來ssh進去</p>

<pre><code>$ qemu-system-arm -M versatileab -kernel ./boot/vmlinuz-3.2.0-4-versatile -initrd ./boot/initrd.img-3.2.0-4-versatile -hda debian.img -m 1024 -append "root=/dev/sda1" -redir tcp:2222::22
</code></pre>

<p>驗收看看是不是真的可以連進去，並且裏面真的是ARM的binary？
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh -p 2222 user@localhost
</span><span class='line'>user@localhost&rsquo;s password:
</span><span class='line'>Linux debian 3.2.0-4-versatile #1 Debian 3.2.65-1+deb7u1 armv5tejl&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;The programs included with the Debian GNU/Linux system are free software;
</span><span class='line'>the exact distribution terms for each program are described in the
</span><span class='line'>individual files in /usr/share/doc/*/copyright.&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span><span class='line'>permitted by applicable law.
</span><span class='line'>You have mail.
</span><span class='line'>Last login: Fri Feb  6 09:35:07 2015
</span><span class='line'>user@debian:~$ file /bin/ls
</span><span class='line'>/bin/ls: ELF 32-bit LSB executable, ARM, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.26, BuildID[sha1]=0x5bc97dbca9ac168932d898a5e2eaf68e8fde5e16, stripped</span></code></pre></td></tr></table></div></figure></p>

<h2>參考資料</h2>

<ul>
<li><a href="http://pominglee.blogspot.tw/2012/11/qemu-arm-debian-linux.html">Dr. Lee&rsquo;s blog: 安裝 qemu arm 版 Debian Linux</a></li>
<li><a href="http://www.bramschoenmakers.nl/en/node/100.html">Connecting to SSH server on QEmu guest</a></li>
<li><a href="https://bbs.archlinux.org/viewtopic.php?id=95326">ArchLinux: Qemu, mounting a raw img to temp file, mount needs a filesystem type.</a></li>
</ul>

]]></content>
  </entry>
  
</feed>
